<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  
  <!-- ❌ REMOVE SPACES at end of src -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  
  <style>
    body { margin: 0; background: #000; }
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    video { width: 100%; max-height: 100vh; background: #000; }
    #loading { color: #fff; text-align: center; font-family: sans-serif; }
    #error { display: none; color: #ff4444; padding: 20px; background: rgba(0,0,0,0.8); }
    #debug { position: fixed; top: 10px; left: 10px; color: #0f0; font-size: 12px; font-family: monospace; background: rgba(0,0,0,0.7); padding: 10px; z-index: 1000; }
  </style>
</head>
<body>
  <div id="container">
    <div id="loading">
      <h3>Loading PTV Sports...</h3>
      <p id="status">Initializing...</p>
    </div>
    <video id="video" controls style="display:none;"></video>
    <div id="error"></div>
  </div>
  
  <!-- Debug console -->
  <pre id="debug"></pre>

  <script>
    const debug = document.getElementById('debug');
    const status = document.getElementById('status');
    
    function log(msg) {
      console.log(msg);
      debug.textContent += msg + '\n';
      status.textContent = msg;
    }

    // ===== FIX 1: Remove spaces from URLs =====
    const originalUrl = 'https://d10.merichunidya.com:1686/hls/willowusa.m3u8?md5=KX-v6eohZQL7fB827l7M0w&expires=1766149086'.trim();
    
    const proxyUrl = `https://hls-proxy.samaraedirisooriya123.workers.dev?url=${encodeURIComponent(originalUrl)}`;
    
    log('Original URL: ' + originalUrl);
    log('Proxy URL: ' + proxyUrl);
    log('Testing proxy fetch...');

    // Test if proxy is reachable
    fetch(proxyUrl, { method: 'HEAD' })
      .then(r => log('Proxy reachable: ' + r.status))
      .catch(e => log('Proxy ERROR: ' + e.message));

    // Telegram initialization
    if (window.Telegram?.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      log('Telegram WebApp initialized');
    } else {
      log('⚠️ Not in Telegram environment');
    }

    const video = document.getElementById('video');
    const loading = document.getElementById('loading');
    const errorDiv = document.getElementById('error');

    if (Hls.isSupported()) {
      log('HLS.js is supported');
      
      const hls = new Hls({
        debug: true, // Enable debug logging
        enableWorker: true,
        maxBufferLength: 30
      });
      
      hls.loadSource(proxyUrl);
      hls.attachMedia(video);
      
      hls.on(Hls.Events.MEDIA_ATTACHED, () => log('Video element attached'));
      
      hls.on(Hls.Events.MANIFEST_LOADING, () => log('Loading manifest...'));
      
      hls.on(Hls.Events.MANIFEST_LOADED, () => log('Manifest loaded successfully'));
      
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        log('Manifest parsed - starting playback');
        loading.style.display = 'none';
        video.style.display = 'block';
        
        video.play().catch(e => {
          log('Autoplay blocked: ' + e.message);
          showError('Tap the video to play');
        });
      });
      
      hls.on(Hls.Events.ERROR, (event, data) => {
        log(`ERROR: ${data.type} - ${data.details}`);
        if (data.fatal) {
          showError(`Fatal error: ${data.type}\n${data.details}`);
          hls.destroy();
        }
      });
      
      // Network errors
      hls.on(Hls.Events.FRAG_LOAD_ERROR, () => log('Fragment load error'));
      hls.on(Hls.Events.NETWORK_ERROR, () => log('Network error'));
      
    } else {
      log('HLS.js NOT supported - trying native');
      if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = proxyUrl;
        video.addEventListener('loadedmetadata', () => {
          log('Native HLS loaded');
          loading.style.display = 'none';
          video.style.display = 'block';
          video.play();
        });
      } else {
        showError('HLS not supported on this device');
      }
    }

    function showError(msg) {
      log('SHOWING ERROR: ' + msg);
      loading.style.display = 'none';
      video.style.display = 'none';
      errorDiv.style.display = 'block';
      errorDiv.textContent = msg;
    }

    // Handle video errors
    video.addEventListener('error', (e) => {
      log('Video element error: ' + e.message);
    });
  </script>
</body>
</html>