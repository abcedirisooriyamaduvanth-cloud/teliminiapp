<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üèè CricketStream Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Monetag -->
<script src='//libtl.com/sdk.js'
  data-zone='10340427'
  data-sdk='show_10340427'></script>

<!-- Telegram -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin:0;
  font-family:system-ui, sans-serif;
  background:linear-gradient(180deg,#052e16,#022c22);
  color:#fff;
}
.hidden{display:none}

header{
  padding:14px;
  text-align:center;
  font-size:20px;
  font-weight:700;
  background:#0008;
}

.section{
  margin:14px;
  padding:14px;
  background:#ffffff14;
  border-radius:14px;
  animation:fadeIn .4s ease;
}

button{
  background:#22c55e;
  border:none;
  padding:12px 18px;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
}

.ad-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  background:#0006;
  border-radius:12px;
}

.loading{
  position:fixed;
  inset:0;
  background:#000c;
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:999;
}
.loading.show{display:flex}

.spinner{
  width:42px;
  height:42px;
  border:4px solid #ffffff33;
  border-top-color:#22c55e;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin-bottom:12px;
}

@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1}}

iframe{
  width:100%;
  height:100vh;
  border:none;
}
</style>
</head>

<body>

<header>üèè CricketStream Pro</header>

<!-- LOADING -->
<div id="loading" class="loading">
  <div class="spinner"></div>
  <div id="loadingText">Loading‚Ä¶</div>
</div>

<!-- LOGIN -->
<div id="login" class="section">
  <p>Authenticate to continue</p>
  <button onclick="login()">Login</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

  <div class="section">
    <b>User:</b> <span id="uname"></span><br>
    <b>UID:</b> <span id="uid"></span><br>
    <b>Minutes:</b> <span id="minutes">0</span><br>
    <b>Ads Watched:</b> <span id="ads">0</span>
  </div>

  <div class="section">
    <h3>üéØ Earn Minutes</h3>
    <div class="ad-row">
      <div>
        <b>Rewarded Ad</b><br>
        +3 minutes
      </div>
      <button onclick="watchAd()">Watch</button>
    </div>
  </div>

  <div class="section">
    <h3>üì∫ Watch Stream</h3>
    <input id="streamUrl"
      placeholder="Paste stream URL"
      style="width:100%;padding:10px;border-radius:10px;border:none">
    <button style="margin-top:10px" onclick="openStream()">Open</button>
  </div>

</div>

<!-- STREAM -->
<div id="viewer" class="hidden">
  <button onclick="closeStream()" style="margin:10px">‚¨Ö Back</button>
  <iframe id="frame"></iframe>
</div>

<script>
/* ================= STATE ================= */
let user = null;
let lastAd = 0;
const COOLDOWN = 6 * 60 * 1000;

/* ================= HELPERS ================= */
const $ = id => document.getElementById(id);

function showLoading(t){
  $('loadingText').innerText = t;
  $('loading').classList.add('show');
}
function hideLoading(){
  $('loading').classList.remove('show');
}

function saveUser(){
  localStorage.setItem('cs_user', JSON.stringify(user));
}
function loadUser(){
  const u = localStorage.getItem('cs_user');
  return u ? JSON.parse(u) : null;
}

/* ================= AUTH ================= */
function login(){
  showLoading("Authenticating‚Ä¶");

  setTimeout(() => {
    const tg = window.Telegram?.WebApp;
    tg?.ready();

    let stored = loadUser();

    if (stored) {
      user = stored;
    } else {
      if (tg?.initDataUnsafe?.user) {
        const tgu = tg.initDataUnsafe.user;
        user = {
          uid: String(tgu.id),
          username: tgu.username || "tg_user",
          minutes: 0,
          ads: 0,
          last_login: Date.now()
        };
      } else {
        // Browser fallback
        user = {
          uid: crypto.randomUUID(),
          username: "test_user",
          minutes: 0,
          ads: 0,
          last_login: Date.now()
        };
      }
    }

    user.last_login = Date.now();
    saveUser();
    renderUser();

    $('login').classList.add('hidden');
    $('dashboard').classList.remove('hidden');
    hideLoading();
  }, 600);
}

function renderUser(){
  $('uname').innerText = user.username;
  $('uid').innerText = user.uid;
  $('minutes').innerText = user.minutes;
  $('ads').innerText = user.ads;
}

/* ================= MONETAG ================= */
function watchAd(){
  if (Date.now() - lastAd < COOLDOWN) {
    alert("Ad cooldown active");
    return;
  }

  if (typeof show_10340427 !== 'function') {
    alert("Ad SDK not ready");
    return;
  }

  showLoading("Watching ad‚Ä¶");
  let rewarded = false;

  try {
    const result = show_10340427('pop');

    if (result && typeof result.then === 'function') {
      result.then(() => rewardUser())
            .catch(() => hideLoading());
    } else {
      // Fallback safety
      setTimeout(rewardUser, 7000);
    }
  } catch {
    hideLoading();
  }

  function rewardUser(){
    if (rewarded) return;
    rewarded = true;

    user.minutes += 3;
    user.ads += 1;
    lastAd = Date.now();
    saveUser();
    renderUser();
    hideLoading();
    alert("+3 minutes earned");
  }
}

/* ================= STREAM ================= */
function openStream(){
  if (user.minutes < 3) {
    alert("Earn minutes first");
    return;
  }
  const url = $('streamUrl').value;
  if (!url) return alert("Enter stream URL");

  user.minutes -= 3;
  saveUser();
  renderUser();

  $('dashboard').classList.add('hidden');
  $('viewer').classList.remove('hidden');
  $('frame').src = url;
}

function closeStream(){
  $('viewer').classList.add('hidden');
  $('dashboard').classList.remove('hidden');
  $('frame').src = '';
}
</script>

</body>
</html>
