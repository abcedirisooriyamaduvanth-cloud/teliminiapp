<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Cricket Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- REQUIRED SCRIPTS (UNCHANGED) -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://libtl.com/sdk.js" data-zone="10340427" data-sdk="show_10340427"></script>

<style>
/* ğŸ”¥ FIRE THEME UI ONLY */
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:radial-gradient(circle at top,#2a0000,#060000);
  color:#fff;
}
.app{padding:16px;max-width:520px;margin:auto;}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header h3{
  color:#ffb703;
  text-shadow:0 0 12px #ff4500;
}

.card{
  background:linear-gradient(180deg,rgba(255,80,0,.18),rgba(0,0,0,.45));
  border-radius:18px;
  padding:16px;
  margin-top:14px;
  box-shadow:0 0 22px rgba(255,69,0,.25);
  animation:fadeUp .4s ease;
}

.btn{
  width:100%;
  padding:14px;
  margin-top:10px;
  background:linear-gradient(135deg,#ff512f,#f09819);
  border:none;
  border-radius:16px;
  color:#fff;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
}
.btn:active{transform:scale(.97)}
.btn:disabled{opacity:.5;cursor:not-allowed}

.status-indicator{
  width:12px;
  height:12px;
  border-radius:50%;
  box-shadow:0 0 12px currentColor;
}

.channel-card{
  background:rgba(255,120,0,.12);
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(255,180,0,.35);
}

.force-refresh-btn{
  background:linear-gradient(135deg,#ff4757,#c44569)!important;
}

.countdown{
  color:#ffcc00;
  font-weight:bold;
  text-align:center;
  margin-top:10px;
}

@keyframes fadeUp{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:translateY(0)}
}
</style>
</head>

<body>
<div class="app">

<!-- HEADER -->
<div class="header">
  <h3>ğŸ”¥ Cricket Rewards</h3>
  <span id="username"></span>
</div>

<!-- STATS -->
<div class="card">
  <h4>Total Earned</h4>
  <p>â± Minutes: <b id="minutes">0</b></p>
  <p>ğŸ’° Earnings: $<b id="earnings">0.00</b></p>
</div>

<!-- EARN -->
<div class="card">
  <h4>âš¡ Earn Minutes</h4>
  <button class="btn" onclick="watchRewarded()">ğŸ¬ Watch Ad (+2 min)</button>
  <button class="btn" onclick="watchPopup()">ğŸ”¥ Popup Ad (+1 min)</button>
  <div class="loader" id="loader">Loading Ad...</div>
</div>

<!-- MATCHES -->
<div class="card">
  <h4>ğŸ† LIVE Cricket Matches</h4>

  <div class="channel-card">
    <div style="display:flex;justify-content:space-between;">
      <h4 style="margin:0;color:#ffb703;">ğŸ Bangladesh Premier League</h4>
      <span id="status-match1" class="status-indicator"></span>
    </div>
    <p id="req-match1">Need 15 minutes</p>
    <button class="btn" id="btn-match1" onclick="joinChannel('match1')">Join Match</button>
  </div>

  <div class="channel-card" style="margin-top:12px;">
    <div style="display:flex;justify-content:space-between;">
      <h4 style="margin:0;color:#ffb703;">ğŸ Mens Big Bash League</h4>
      <span id="status-match2" class="status-indicator"></span>
    </div>
    <p id="req-match2">Need 15 minutes</p>
    <button class="btn" id="btn-match2" onclick="joinChannel('match2')">Join Match</button>
  </div>
</div>

<div class="countdown" id="countdown">
 â° Link expires in <span id="timer">10:00</span>
</div>

<button class="btn force-refresh-btn" onclick="forceRefresh()">
 ğŸ”„ FORCE REFRESH
</button>

<div class="card">
 <h4>Debug Log</h4>
 <pre id="debug" style="font-size:12px;max-height:200px;overflow:auto;"></pre>
</div>

</div>

<!-- ğŸ”´ SCRIPT BELOW IS 100% UNCHANGED -->

<script>
/* ---------------- TELEGRAM USER ---------------- */
const tg = Telegram.WebApp;
tg.ready();
const user = tg.initDataUnsafe.user;
document.getElementById("username").innerText = "@" + (user.username || "player");

/* ---------------- FIREBASE ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBhwMJdFGmbxE8nAVKPyRJJzuHn6xmyI7Q",
  authDomain: "cricketteligram.firebaseapp.com",
  databaseURL: "https://cricketteligram-default-rtdb.firebaseio.com",
  projectId: "cricketteligram",
  storageBucket: "cricketteligram.appspot.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const userRef = db.ref("users/" + user.id);

/* ---------------- CHANNEL NAMES ---------------- */
const CHANNEL_NAMES = {
  match1: 'India vs Australia',
  match2: 'England vs South Africa'
};

/* ---------------- DEBUG HELPERS ---------------- */
function debugLog(label, obj) {
  try {
    const el = document.getElementById('debug');
    if (!el) return;
    const time = new Date().toLocaleTimeString();
    const entry = `[${time}] ${label}: ${typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2)}\n`;
    el.textContent = entry + el.textContent;
  } catch (e) { /* ignore */ }
}

/* ---------------- FORCE REFRESH FUNCTION ---------------- */
function forceRefresh() {
  debugLog('FORCE REFRESH triggered', 'Clearing cache and reloading...');
  window.userData = null;
  
  userRef.once("value").then(snap => {
    const data = snap.val();
    debugLog('Force refresh result', {
      userId: user.id,
      totalMinutes: data?.totalMinutes,
      joinedChannels: data?.joinedChannels
    });
    
    // Auto-clear expired pending joins (>5 min old)
    const joinedChannels = data?.joinedChannels || {};
    const updates = {};
    let cleared = false;
    
    Object.keys(joinedChannels).forEach(channelId => {
      const ch = joinedChannels[channelId];
      // If marked as joined but very recent (<3 min), keep it
      // If pending/old, clear it
      const age = Date.now() - (ch.joinedAt || ch.pendingAt || 0);
      if (ch.joinedAt && age < 3 * 60 * 1000) {
        // Keep recent joins
      } else if (ch.joinedAt && age > 3 * 60 * 1000) {
        // Confirmed join (older than 3 min)
      } else if (ch.pendingAt && age > 5 * 60 * 1000) {
        // Clear expired pending
        updates[`joinedChannels/${channelId}`] = null;
        cleared = true;
        debugLog('Cleared expired pending', channelId);
      }
    });
    
    if (cleared) {
      userRef.update(updates);
    }
    
    window.userData = data;
    updateChannelButtons(data?.totalMinutes || 0, data?.joinedChannels || {});
    alert('âœ… State refreshed!');
  }).catch(err => {
    debugLog('Force refresh ERROR', err.message);
  });
}

/* ---------------- INIT USER ---------------- */
userRef.once("value").then(snap => {
  if (!snap.exists()) {
    userRef.set({
      uid: user.id,
      username: user.username || "",
      name: user.first_name || "",
      totalMinutes: 0,
      totalEarnings: 0,
      adViews: 0,
      lastEarnedAt: Date.now(),
      joinedChannels: {}
    });
  }
  debugLog('User initialized', user.id);
});

/* ---------------- REALTIME LISTENER WITH DEBUG ---------------- */
userRef.on("value", snap => {
  const d = snap.val();
  debugLog('FIREBASE LISTENER TRIGGERED', {
    hasData: !!d,
    totalMinutes: d?.totalMinutes,
    joinedChannelsKeys: Object.keys(d?.joinedChannels || {})
  });
  
  if (!d) return;
  
  window.userData = d;
  document.getElementById("minutes").innerText = d.totalMinutes || 0;
  document.getElementById("earnings").innerText = (d.totalEarnings || 0).toFixed(2);
  updateChannelButtons(d.totalMinutes || 0, d.joinedChannels || {});
});

/* ---------------- REWARD LOGIC ---------------- */
function reward(minutes) {
  userRef.transaction(d => {
    if (!d) return d;
    d.totalMinutes += minutes;
    d.adViews += 1;
    d.totalEarnings += minutes * 0.02;
    d.lastEarnedAt = Date.now();
    return d;
  });
}

/* ---------------- ADS SDK LOADER & FUNCTIONS ---------------- */
let adSdkReady = false;

function waitForSdk() {
  return new Promise((resolve, reject) => {
    let attempts = 0;
    const checkInterval = setInterval(() => {
      if (typeof show_10340427 === 'function') {
        adSdkReady = true;
        clearInterval(checkInterval);
        debugLog('Monetag SDK loaded successfully');
        resolve();
      } else if (attempts > 50) {
        clearInterval(checkInterval);
        debugLog('Monetag SDK failed to load after 5 seconds');
        reject('SDK not loaded');
      }
      attempts++;
    }, 100);
  });
}

waitForSdk().catch(err => {
  debugLog('SDK Error', err);
});

function loader(show) {
  document.getElementById("loader").style.display = show ? "block" : "none";
}

async function watchRewarded() {
  if (!adSdkReady) {
    alert('âš ï¸ Ad SDK still loading... wait a moment');
    return;
  }
  
  loader(true);
  debugLog('Starting rewarded ad', null);
  
  try {
    await show_10340427();
    reward(2);
    alert("ğŸ‰ +2 minutes earned!");
    debugLog('Rewarded ad completed', '+2 min');
  } catch (e) {
    debugLog('Rewarded ad error', e.message);
    alert("âŒ Ad failed to load. Check connection.");
  } finally {
    loader(false);
  }
}

async function watchPopup() {
  if (!adSdkReady) {
    alert('âš ï¸ Ad SDK still loading... wait a moment');
    return;
  }
  
  loader(true);
  debugLog('Starting popup ad', null);
  
  try {
    await show_10340427('pop');
    reward(1);
    alert("ğŸ”¥ +1 minute earned!");
    debugLog('Popup ad completed', '+1 min');
  } catch (e) {
    debugLog('Popup ad error', e.message);
    alert("âŒ Ad failed to load. Check connection.");
  } finally {
    loader(false);
  }
}

/* ---------------- CHANNEL BUTTONS ---------------- */
function updateChannelButtons(minutes, joinedChannels) {
  Object.keys(CHANNEL_NAMES).forEach(channel => {
    const btn = document.getElementById(`btn-${channel}`);
    const reqText = document.getElementById(`req-${channel}`);
    const status = document.getElementById(`status-${channel}`);
    if (!btn || !reqText || !status) return;
    
    const channelData = joinedChannels?.[channel] || {};
    const isJoined = channelData.joinedAt;
    const inviteTime = channelData.inviteGeneratedAt || channelData.joinedAt;
    
    // If joined but within 3 minute window, show reset option
    const isRecent = isJoined && (Date.now() - isJoined < 3 * 60 * 1000);
    
    if (isJoined && !isRecent) {
      // Confirmed join - hide button
      status.style.background = "#00ff00";
      btn.style.display = "none";
      reqText.innerHTML = "âœ… ACCESS ACTIVE - Channel Joined";
      reqText.style.color = "#00ff00";
    } else if (isJoined && isRecent) {
      // Recent join - show reset option for 3 minutes
      status.style.background = "#ffaa00";
      btn.innerHTML = "âŒ DIDN'T WORK? RESET";
      btn.style.background = "linear-gradient(135deg,#ff4757,#c44569)";
      btn.disabled = false;
      btn.style.display = "block";
      btn.onclick = () => resetFailedJoin(channel);
      reqText.innerHTML = `â° VERIFYING JOIN (${Math.ceil((3 * 60 * 1000 - (Date.now() - isJoined)) / 1000)}s)`;
      reqText.style.color = "#ffaa00";
    } else if (minutes >= 15) {
      // Ready to join
      status.style.background = "#00ff00";
      btn.innerHTML = "ğŸ”“ JOIN NOW";
      btn.style.background = "linear-gradient(135deg,#00d2d3,#00a8ff)";
      btn.disabled = false;
      btn.style.display = "block";
      btn.onclick = () => joinChannel(channel);
      reqText.innerHTML = "âœ… YOU QUALIFY (15+ MINUTES)";
      reqText.style.color = "#00ff00";
    } else {
      // Locked
      status.style.background = "#ffcc00";
      btn.innerHTML = "ğŸ”’ LOCKED";
      btn.style.background = "linear-gradient(135deg,#576574,#2c2c54)";
      btn.disabled = true;
      btn.style.display = "block";
      btn.onclick = () => joinChannel(channel);
      reqText.innerHTML = `NEED ${15 - minutes} MORE MINUTES`;
      reqText.style.color = "#ffcc00";
    }
  });
}

/* ---------------- RESET FAILED JOIN ---------------- */
async function resetFailedJoin(channelId) {
  if (confirm('ğŸ”„ Reset join status?\n\nUse this ONLY if joining failed. You will NOT be refunded minutes. Click "Force Refresh" after reset.')) {
    await userRef.child(`joinedChannels/${channelId}`).remove();
    debugLog('Reset failed join for channel', channelId);
    alert('âœ… Status reset! Try joining again.');
    forceRefresh();
  }
}

/* ---------------- JOIN CHANNEL ---------------- */
async function joinChannel(channelId) {
  if (!user) {
    alert('âŒ Open from Telegram Web App');
    return;
  }

  const channelName = CHANNEL_NAMES[channelId];
  const btn = document.getElementById(`btn-${channelId}`);
  btn.innerHTML = 'â³ Generating...';
  btn.disabled = true;

  const payload = { userId: String(user.id), channelId };
  const endpoint = 'https://ancient-shadow-773c.samaraedirisooriya123.workers.dev/api/generate-invite';

  try {
    debugLog('POST -> Worker', { url: endpoint, payload });
    
    const response = await fetch(endpoint, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await response.json().catch(() => ({}));
    debugLog('Worker response', { ok: response.ok, status: response.status, data });

    if (response.ok && data.inviteLink) {
      debugLog('Opening invite', data.inviteLink);
      window.open(data.inviteLink, '_blank');
      
      alert('âœ… Link generated! Click it within 10 minutes.\n\nAFTER joining, click "Force Refresh" to verify.');
      return;
    }

    if (data?.error && /already/i.test(data.error)) {
      alert('â„¹ï¸ Already a member! Click "Force Refresh" to update status.');
      forceRefresh();
      return;
    }

    throw new Error(data.error || `HTTP ${response.status}: No invite link`);

  } catch (error) {
    debugLog('CRITICAL ERROR', error.message);
    alert(`âŒ ${error.message}\n\nCheck debug log.`);
    btn.disabled = false;
  }
}

/* ---------------- THEME ---------------- */
document.documentElement.style.colorScheme = 'dark';
</script>

</body>
</html>
