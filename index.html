<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Cricket Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Monetag -->
<script src="//libtl.com/sdk.js" data-zone="10340427" data-sdk="show_10340427"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { margin: 0; font-family: 'Inter', sans-serif; background: linear-gradient(180deg,#0b1020,#050814); color: #fff; }
.app { padding: 16px; }
.header { display: flex; justify-content: space-between; align-items: center; }
.card { background: rgba(255,255,255,0.08); border-radius: 16px; padding: 16px; margin-top: 14px; animation: fadeUp .5s ease; }
.btn { width: 100%; padding: 14px; margin-top: 10px; background: linear-gradient(135deg,#00c6ff,#0072ff); border: none; border-radius: 12px; color: #fff; font-size: 16px; cursor: pointer; }
.btn:active { transform: scale(0.97); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.loader { display: none; text-align: center; margin-top: 10px; }
.status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; }
.channel-card { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; border: 1px solid #4a6572; margin-bottom: 12px; }
@keyframes fadeUp { from {opacity:0; transform:translateY(20px)} to {opacity:1; transform:translateY(0)} }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h3>üèè Cricket Rewards</h3>
    <span id="username"></span>
  </div>

  <div class="card">
    <h4>Total Earned</h4>
    <p>‚è± Minutes: <b id="minutes">0</b></p>
    <p>üí∞ Earnings: $<b id="earnings">0.00</b></p>
  </div>

  <div class="card">
    <h4>Earn Minutes</h4>
    <button class="btn" onclick="watchRewarded()">üé¨ Watch Ad (+2 min)</button>
    <button class="btn" onclick="watchPopup()">üî• Popup Ad (+1 min)</button>
    <div class="loader" id="loader">Loading Ad...</div>
  </div>

  <div class="card">
    <h4>üèÜ LIVE Cricket Matches</h4>
    <div style="background: rgba(255,50,50,0.15); border-left: 3px solid #ff4d4d; padding: 10px; margin: 10px 0; border-radius: 0 8px 8px 0; font-size: 14px;">
      <strong>‚ö†Ô∏è SECURITY WARNING:</strong> Invite links expire in 60 seconds and only work for your account. Sharing links will get you permanently banned!
    </div>
    
    <div style="display: grid; gap: 12px; margin-top: 12px;">
      <!-- Match 1 -->
      <div class="channel-card">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <h4 style="margin: 0 0 5px 0; color: #00c6ff;">üèè India vs Australia</h4>
          <span class="status-indicator" id="status-match1" style="background: #ff4d4d;"></span>
        </div>
        <p style="margin: 0 0 8px 0; font-size: 14px; color: #aaa;">Live from Cricket_live_streeming_VIP_channel_01</p>
        <p style="margin: 0 0 8px 0; font-size: 13px;">
          <span id="req-match1" style="color: #ffcc00; font-weight: bold;">Need 15 minutes to join</span>
        </p>
        <button class="btn" style="padding: 10px; margin-top: 5px; background: linear-gradient(135deg,#ff6b6b,#ee5a24);" onclick="joinChannel('match1')" id="btn-match1">Join Match</button>
      </div>
      
      <!-- Match 2 -->
      <div class="channel-card">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <h4 style="margin: 0 0 5px 0; color: #00c6ff;">üèè England vs South Africa</h4>
          <span class="status-indicator" id="status-match2" style="background: #ff4d4d;"></span>
        </div>
        <p style="margin: 0 0 8px 0; font-size: 14px; color: #aaa;">Live from Cricket_live_streeming_VIP_channel_02</p>
        <p style="margin: 0 0 8px 0; font-size: 13px;">
          <span id="req-match2" style="color: #ffcc00; font-weight: bold;">Need 15 minutes to join</span>
        </p>
        <button class="btn" style="padding: 10px; margin-top: 5px; background: linear-gradient(135deg,#48dbfb,#1e90ff);" onclick="joinChannel('match2')" id="btn-match2">Join Match</button>
      </div>
      
    </div>
  </div>
  
  <div class="card">
    <h4>Debug Log</h4>
    <pre id="debug" style="max-height:200px; overflow:auto; white-space:pre-wrap; background: rgba(0,0,0,0.12); padding: 8px; border-radius: 8px; font-size:12px; color:#fff;"></pre>
  </div>
</div>

<script>
/* ---------------- TELEGRAM USER ---------------- */
const tg = Telegram.WebApp;
tg.ready();
const user = tg.initDataUnsafe.user;
document.getElementById("username").innerText = "@" + (user.username || "player");
// initial environment debug info
debugLog('Page origin', location.origin);
debugLog('User agent', navigator.userAgent);
try { debugLog('Telegram initDataUnsafe', tg.initDataUnsafe); } catch(e) { debugLog('Telegram initDataUnsafe', 'unavailable'); }

/* ---------------- FIREBASE ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBhwMJdFGmbxE8nAVKPyRJJzuHn6xmyI7Q",
  authDomain: "cricketteligram.firebaseapp.com",
  databaseURL: "https://cricketteligram-default-rtdb.firebaseio.com",
  projectId: "cricketteligram",
  storageBucket: "cricketteligram.appspot.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const userRef = db.ref("users/" + user.id);

/* ---------------- CHANNEL NAMES ---------------- */
const CHANNEL_NAMES = {
  match1: 'India vs Australia',
  match2: 'England vs South Africa'
};

/* ---------------- DEBUG HELPERS ---------------- */
function debugLog(label, obj) {
  try {
    const el = document.getElementById('debug');
    if (!el) return;
    const time = new Date().toLocaleTimeString();
    const entry = `[${time}] ${label}: ` + (obj === undefined ? '' : (typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2))) + "\n";
    el.textContent = entry + el.textContent;
  } catch (e) { /* ignore */ }
}

/* ---------------- INIT USER ---------------- */
userRef.once("value").then(snap => {
  if (!snap.exists()) {
    userRef.set({
      uid: user.id,
      username: user.username || "",
      name: user.first_name || "",
      totalMinutes: 0,
      totalEarnings: 0,
      adViews: 0,
      lastEarnedAt: Date.now(),
      joinedChannels: {}
    });
  }
});

userRef.on("value", snap => {
  const d = snap.val();
  if (!d) return;
  // keep latest user snapshot globally available for join logic
  window.userData = d;
  document.getElementById("minutes").innerText = d.totalMinutes;
  document.getElementById("earnings").innerText = d.totalEarnings.toFixed(2);
  updateChannelButtons(d.totalMinutes, d.joinedChannels || {});
});

/* ---------------- REWARD LOGIC ---------------- */
function reward(minutes) {
  userRef.transaction(d => {
    if (!d) return d;
    d.totalMinutes += minutes;
    d.adViews += 1;
    d.totalEarnings += minutes * 0.02;
    d.lastEarnedAt = Date.now();
    return d;
  });
}

/* ---------------- ADS ---------------- */
function loader(show) {
  document.getElementById("loader").style.display = show ? "block" : "none";
}

function watchRewarded() {
  loader(true);
  show_10340427().then(() => {
    reward(2);
    alert("üéâ You earned 2 minutes!");
    loader(false);
  }).catch(() => loader(false));
}

function watchPopup() {
  loader(true);
  show_10340427('pop').then(() => {
    reward(1);
    alert("üî• You earned 1 minute!");
    loader(false);
  }).catch(() => loader(false));
}

/* ---------------- CHANNEL BUTTONS ---------------- */
function updateChannelButtons(minutes, joinedChannels) {
  Object.keys(CHANNEL_NAMES).forEach(channel => {
    const btn = document.getElementById(`btn-${channel}`);
    const reqText = document.getElementById(`req-${channel}`);
    const status = document.getElementById(`status-${channel}`);
    if (!btn || !reqText || !status) return;
    
    const isJoined = joinedChannels[channel] && joinedChannels[channel].joinedAt;
    
    if (isJoined) {
      status.style.background = "#00ff00";
      btn.innerHTML = "‚úÖ JOINED";
      btn.style.background = "linear-gradient(135deg,#00d2d3,#00a8ff)";
      btn.disabled = true;
      reqText.innerHTML = "‚úÖ ACCESS ACTIVE";
      reqText.style.color = "#00ff00";
    } else if (minutes >= 15) {
      status.style.background = "#00ff00";
      btn.innerHTML = "üîì JOIN NOW";
      btn.style.background = "linear-gradient(135deg,#00d2d3,#00a8ff)";
      btn.disabled = false;
      reqText.innerHTML = "‚úÖ YOU QUALIFY (15+ MINUTES)";
      reqText.style.color = "#00ff00";
    } else {
      status.style.background = "#ffcc00";
      btn.innerHTML = "üîí LOCKED";
      btn.style.background = "linear-gradient(135deg,#576574,#2c2c54)";
      btn.disabled = true;
      reqText.innerHTML = `NEED ${15 - minutes} MORE MINUTES`;
      reqText.style.color = "#ffcc00";
    }
  });
}

/* ---------------- JOIN CHANNEL ---------------- */
async function joinChannel(channelId) {
  if (!user) {
    alert('‚ùå Please open from Telegram');
    return;
  }

  const channelName = CHANNEL_NAMES[channelId];
  const btn = document.getElementById(`btn-${channelId}`);
  btn.innerHTML = '‚è≥ Generating...';
  btn.disabled = true;

  const payload = { userId: String(user.id), channelId };
  const primary = 'https://ancient-shadow-773c.samaraedirisooriya123.workers.dev/api/generate-invite';
  const fallback = 'http://143.110.254.170:3000/api/generate-invite';

  function markJoined() {
    const updatedChannels = { ...((window.userData && window.userData.joinedChannels) || {}) };
    updatedChannels[channelId] = { joinedAt: Date.now(), channelName };
    userRef.update({ joinedChannels: updatedChannels });
  }

  try {
    // Try primary endpoint first
    debugLog('POST -> primary', { url: primary, payload });
    let response;
    // Try primary endpoint with one retry for transient/preflight issues
    let attempt = 0;
    while (attempt < 2) {
      attempt += 1;
      try {
        debugLog('Fetch attempt', { attempt, url: primary, online: navigator.onLine });
        response = await fetch(primary, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        break;
      } catch (netErr) {
        debugLog('Network error on primary fetch', { attempt, err: netErr.message || String(netErr) });
        if (attempt >= 2) throw netErr;
        // small backoff before retry
        await new Promise(r => setTimeout(r, 350));
      }
    }

    let data = {};
    try { data = await response.json(); } catch(e) { data = {}; }
    debugLog('Primary response', { ok: response.ok, status: response.status, data });

    if (response.ok && data.inviteLink) {
      debugLog('Opening invite', data.inviteLink);
      window.open(data.inviteLink, '_blank');
      markJoined();
      alert('‚úÖ Link generated! Expires in 60 seconds.\n\n‚ö†Ô∏è Use it immediately - DO NOT SHARE!');
      return;
    }

    // If primary says user already a member, mark as joined
    if (data && data.error && /already/i.test(data.error)) {
      markJoined();
      alert('‚ÑπÔ∏è You are already a member. Access marked as joined.');
      return;
    }

    // Try fallback endpoint (may be blocked by mixed-content if page is HTTPS)
    debugLog('POST -> fallback', { url: fallback, payload });
    try {
      response = await fetch(fallback, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    } catch (netErr) {
      debugLog('Network error on fallback fetch', netErr.message || netErr);
      throw netErr;
    }

    try { data = await response.json(); } catch(e) { data = {}; }
    debugLog('Fallback response', { ok: response.ok, status: response.status, data });

    if (response.ok && data.inviteLink) {
      window.open(data.inviteLink, '_blank');
      markJoined();
      alert('‚úÖ Link generated (fallback)! Expires in 60 seconds.\n\n‚ö†Ô∏è Use it immediately - DO NOT SHARE!');
      return;
    }

    if (data && data.error && /already/i.test(data.error)) {
      markJoined();
      alert('‚ÑπÔ∏è You are already a member. Access marked as joined.');
      return;
    }

    throw new Error(data.error || 'No invite link returned');

  } catch (error) {
    alert(`‚ùå ${error.message}`);
  } finally {
    // refresh buttons based on latest DB snapshot
    updateChannelButtons(
      parseInt(document.getElementById("minutes").innerText) || 0,
      (window.userData && window.userData.joinedChannels) || {}
    );
    btn.disabled = false;
  }
}

/* ---------------- THEME ---------------- */
document.documentElement.style.colorScheme = 'dark';
</script>

</body>
</html>