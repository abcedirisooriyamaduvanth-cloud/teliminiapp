<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Cricket Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Telegram -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Monetag -->
<script src="https://libtl.com/sdk.js" data-zone="10340427" data-sdk="show_10340427"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: radial-gradient(circle at top, #0f1b3d, #050814);
  color: #fff;
}

.app {
  padding: 16px;
  max-width: 520px;
  margin: auto;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header h3 {
  font-family: 'Orbitron', sans-serif;
  letter-spacing: 1px;
}

.card {
  background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.03));
  border-radius: 18px;
  padding: 16px;
  margin-top: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
  animation: fadeUp .5s ease;
}

.step {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
}

.step span {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg,#00c6ff,#0072ff);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.btn {
  width: 100%;
  padding: 14px;
  margin-top: 10px;
  background: linear-gradient(135deg,#00c6ff,#0072ff);
  border: none;
  border-radius: 14px;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  transition: .2s;
}

.btn:active { transform: scale(.96); }
.btn:disabled { opacity: .5; }

.loader {
  display: none;
  text-align: center;
  margin-top: 8px;
  color: #ffcc00;
}

.progress-wrap {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.progress-ring {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background:
    conic-gradient(#00ffcc calc(var(--p) * 1%), rgba(255,255,255,.15) 0);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Orbitron';
  font-size: 14px;
}

.channel-card {
  background: linear-gradient(145deg, rgba(255,255,255,.14), rgba(255,255,255,.04));
  border-radius: 14px;
  padding: 14px;
  border: 1px solid rgba(255,255,255,.15);
  margin-bottom: 14px;
}

.status-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.countdown {
  display: none;
  text-align: center;
  color: #ffcc00;
  font-weight: bold;
  margin-top: 10px;
}

@keyframes fadeUp {
  from { opacity:0; transform:translateY(20px); }
  to { opacity:1; transform:translateY(0); }
}
</style>
</head>

<body>
<div class="app">

  <!-- HEADER -->
  <div class="header">
    <h3>üèè CRICKET QUEST</h3>
    <small id="username"></small>
  </div>

  <!-- HOW IT WORKS -->
  <div class="card">
    <h4>üéÆ How It Works</h4>
    <div class="step"><span>1</span> Watch ads & earn minutes</div>
    <div class="step"><span>2</span> Reach <b>15 minutes</b></div>
    <div class="step"><span>3</span> Match unlocks</div>
    <div class="step"><span>4</span> Join channel ‚Üí time starts reducing</div>
  </div>

  <!-- PROGRESS -->
  <div class="card progress-wrap">
    <div>
      <h4>Your Power</h4>
      <p>‚è± Minutes: <b id="minutes">0</b></p>
      <p>üí∞ Earnings: $<b id="earnings">0.00</b></p>
    </div>
    <div class="progress-ring" id="ring" style="--p:0">
      <span id="ringText">0/15</span>
    </div>
  </div>

  <!-- EARN -->
  <div class="card">
    <h4>‚ö° Earn Minutes</h4>
    <button class="btn" onclick="watchRewarded()">üé¨ Watch Ad (+2 min)</button>
    <button class="btn" onclick="watchPopup()">üî• Popup Ad (+1 min)</button>
    <div class="loader" id="loader">Loading ad...</div>
  </div>

  <!-- MATCHES -->
  <div class="card">
    <h4>üèÜ Live Matches</h4>

    <div class="channel-card">
      <div style="display:flex;justify-content:space-between">
        <b>Bangladesh Premier League</b>
        <span id="status-match1" class="status-indicator"></span>
      </div>
      <p id="req-match1">Need 15 minutes</p>
      <button class="btn" id="btn-match1" onclick="joinChannel('match1')">Join</button>
    </div>

    <div class="channel-card">
      <div style="display:flex;justify-content:space-between">
        <b>Big Bash League</b>
        <span id="status-match2" class="status-indicator"></span>
      </div>
      <p id="req-match2">Need 15 minutes</p>
      <button class="btn" id="btn-match2" onclick="joinChannel('match2')">Join</button>
    </div>
  </div>

  <div class="countdown" id="countdown">
    ‚è∞ Link expires in <span id="timer">10:00</span>
  </div>

</div>

<script>
/* TELEGRAM */
const tg = Telegram.WebApp;
tg.ready();
const user = tg.initDataUnsafe.user;
document.getElementById("username").innerText = "@" + (user?.username || "player");

/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBhwMJdFGmbxE8nAVKPyRJJzuHn6xmyI7Q",
  authDomain: "cricketteligram.firebaseapp.com",
  databaseURL: "https://cricketteligram-default-rtdb.firebaseio.com",
  projectId: "cricketteligram"
});

const db = firebase.database();
const userRef = db.ref("users/" + user.id);

/* INIT */
userRef.once("value").then(s => {
  if (!s.exists()) {
    userRef.set({
      uid: user.id,
      username: user.username || "",
      totalMinutes: 0,
      totalEarnings: 0,
      adViews: 0,
      joinedChannels: {}
    });
  }
});

/* REALTIME */
userRef.on("value", s => {
  const d = s.val();
  if (!d) return;
  document.getElementById("minutes").innerText = d.totalMinutes || 0;
  document.getElementById("earnings").innerText = (d.totalEarnings || 0).toFixed(2);
  const p = Math.min((d.totalMinutes || 0) / 15 * 100, 100);
  document.getElementById("ring").style.setProperty("--p", p);
  document.getElementById("ringText").innerText = Math.min(d.totalMinutes,15)+"/15";
  updateChannelButtons(d.totalMinutes || 0, d.joinedChannels || {});
});

/* REWARD */
function reward(m) {
  userRef.transaction(d => {
    d.totalMinutes += m;
    d.totalEarnings += m * 0.02;
    d.adViews += 1;
    return d;
  });
}

/* ADS */
function loader(v){document.getElementById("loader").style.display=v?"block":"none";}
async function watchRewarded(){loader(true);await show_10340427();reward(2);loader(false);}
async function watchPopup(){loader(true);await show_10340427('pop');reward(1);loader(false);}

/* CHANNELS */
const CHANNELS={match1:'A',match2:'B'};
function updateChannelButtons(m,j){
  Object.keys(CHANNELS).forEach(c=>{
    const btn=document.getElementById(`btn-${c}`);
    const req=document.getElementById(`req-${c}`);
    const st=document.getElementById(`status-${c}`);
    if(j[c]?.joinedAt){
      st.style.background="#00ff00";
      btn.style.display="none";
      req.innerText="‚úÖ Joined";
    } else if(m>=15){
      st.style.background="#00ff00";
      btn.disabled=false;
      req.innerText="Unlocked";
    } else {
      st.style.background="#ffaa00";
      btn.disabled=true;
      req.innerText=`Need ${15-m} more minutes`;
    }
  });
}

/* JOIN */
async function joinChannel(id){
  await fetch('https://ancient-shadow-773c.samaraedirisooriya123.workers.dev/api/generate-invite',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({userId:String(user.id),channelId:id})
  }).then(r=>r.json()).then(d=>{
    if(d.inviteLink) window.open(d.inviteLink,'_blank');
  });
}
</script>
</body>
</html>
